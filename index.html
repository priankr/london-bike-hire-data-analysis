<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>40781</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<section id="london-bicycle-hires-data-analysis" class="cell markdown">
<h1>London Bicycle Hires Data Analysis</h1>
<p>Analysis of BigQuery Public Dataset on London Biclycle Hires using BigQuery/MySQL and Python.</p>
<p>Dataset contains the number of hires of London's Santander Cycle Hire Scheme from 2011 to present. Data includes start and stop timestamps, station names and ride duration.</p>
</section>
<div class="cell code" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T14:11:39.48973Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T14:11:38.413953Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T14:11:38.414008Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T14:11:39.490865Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T14:11:38.412866Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span></code></pre></div>
</div>
<div class="cell code" data-_kg_hide-output="true" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T13:25:34.736984Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T13:25:15.366629Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T13:25:15.36683Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T13:25:34.737966Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T13:25:15.365641Z&quot;}" data-jupyter="{&quot;source_hidden&quot;:true}" data-trusted="true">
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Set up feedback system</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="im">from</span> learntools.core <span class="im">import</span> binder</span>
<span id="cb2-3"><a href="#cb2-3"></a>binder.bind(<span class="bu">globals</span>())</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="im">from</span> learntools.sql_advanced.ex2 <span class="im">import</span> <span class="op">*</span></span></code></pre></div>
</div>
<div class="cell code" data-_kg_hide-output="true" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T13:25:36.762774Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T13:25:34.742703Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T13:25:34.742736Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T13:25:36.763788Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T13:25:34.74243Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="im">from</span> google.cloud <span class="im">import</span> bigquery</span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co"># Create a &quot;Client&quot; object</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>client <span class="op">=</span> bigquery.Client()</span>
<span id="cb3-5"><a href="#cb3-5"></a></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co"># Construct a reference to the &quot;london_bicycle&quot; dataset</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>dataset_ref <span class="op">=</span> client.dataset(<span class="st">&quot;london_bicycles&quot;</span>, project<span class="op">=</span><span class="st">&quot;bigquery-public-data&quot;</span>)</span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co"># API request - fetch the dataset</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>dataset <span class="op">=</span> client.get_dataset(dataset_ref)</span>
<span id="cb3-11"><a href="#cb3-11"></a></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co"># Construct a reference to the &quot;cycle_hire&quot; and &quot;cycle_stations&quot; tables</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>cycle_hire_table_ref <span class="op">=</span> dataset_ref.table(<span class="st">&quot;cycle_hire&quot;</span>)</span>
<span id="cb3-14"><a href="#cb3-14"></a>cycle_stations_table_ref <span class="op">=</span> dataset_ref.table(<span class="st">&quot;cycle_stations&quot;</span>)</span>
<span id="cb3-15"><a href="#cb3-15"></a></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="co"># API request - fetch the table</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>cycle_hire_table <span class="op">=</span> client.get_table(cycle_hire_table_ref)</span>
<span id="cb3-18"><a href="#cb3-18"></a>cycle_stations_table <span class="op">=</span> client.get_table(cycle_stations_table_ref)</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T13:27:44.554118Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T13:27:43.944145Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T13:27:43.944173Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T13:27:44.554874Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T13:27:43.94389Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># Preview the first five lines of cycle_hire_table</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>client.list_rows(cycle_hire_table, max_results<span class="op">=</span><span class="dv">5</span>).to_dataframe()</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T13:27:45.095043Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T13:27:44.557413Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T13:27:44.557461Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T13:27:45.09599Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T13:27:44.556556Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Preview the first five lines of cycle_stations_table</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>client.list_rows(cycle_stations_table, max_results<span class="op">=</span><span class="dv">5</span>).to_dataframe()</span></code></pre></div>
</div>
<section id="extracting-tabular-data-through-bigquerysql" class="cell markdown">
<h1>Extracting Tabular Data Through BigQuery/SQL</h1>
<h2 id="trip-duration">Trip Duration</h2>
</section>
<div class="cell code" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T13:27:52.851165Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T13:27:51.049745Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T13:27:51.049774Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T13:27:52.852164Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T13:27:51.049496Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># Query to count the trip duration for the top 100 trips </span></span>
<span id="cb6-2"><a href="#cb6-2"></a>bike_trips_query <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="st">                    SELECT</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="st">                        bike_id,</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="st">                        trip_duration_minutes,</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="st">                        start_station_name,</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="st">                        end_station_name,</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="st">                        trip_year</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="st">                    FROM(</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="st">                        SELECT </span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="st">                        bike_id,</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="st">                        start_station_name,</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="st">                        end_station_name,</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="st">                        -- Calculating the trip duration in minutes -- </span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="st">                        DATETIME_DIFF(end_date,start_date,minute) AS trip_duration_minutes,</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="st">                        -- Identifying the trip year--</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="st">                        EXTRACT(YEAR FROM start_date) as trip_year</span></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="st">                        FROM `bigquery-public-data.london_bicycles.cycle_hire`</span></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="st">                        -- Between the years of 2016 and 2017 -- </span></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="st">                        WHERE EXTRACT(YEAR FROM start_date) BETWEEN 2015 AND 2017</span></span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="st">                        LIMIT 100 </span></span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="st">                    ) AS t</span></span>
<span id="cb6-23"><a href="#cb6-23"></a><span class="st">                    ORDER BY trip_duration_minutes DESC</span></span>
<span id="cb6-24"><a href="#cb6-24"></a><span class="st">                  &quot;&quot;&quot;</span></span>
<span id="cb6-25"><a href="#cb6-25"></a></span>
<span id="cb6-26"><a href="#cb6-26"></a><span class="co"># Run the query, and return a pandas DataFrame</span></span>
<span id="cb6-27"><a href="#cb6-27"></a>trip_duration_result <span class="op">=</span> client.query(bike_trips_query).result().to_dataframe()</span>
<span id="cb6-28"><a href="#cb6-28"></a>trip_duration_result.head()</span></code></pre></div>
</div>
<div class="cell markdown">
<p>We now have a table of the 100 longest bike trips along with their duration, origin, destination between 2015 and 2017.</p>
<h2 id="daily-number-of-trips">Daily Number of Trips</h2>
</div>
<div class="cell code" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T13:34:26.058484Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T13:34:20.693744Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T13:34:20.693785Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T13:34:26.059671Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T13:34:20.693143Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># Query to count the daily number of trips in 2015 as well as the cumalative number of trips</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>bike_trips_query <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="st">                    -- Creating a sub query block trips_by_day with trip dates and number of trips --</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="st">                    WITH trips_by_day AS</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="st">                    (</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="st">                    SELECT </span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="st">                        DATE(start_date) AS trip_date,</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="st">                        COUNT(*) as num_trips</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="st">                    FROM `bigquery-public-data.london_bicycles.cycle_hire`</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="st">                    WHERE EXTRACT(YEAR FROM start_date) = 2015</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="st">                    GROUP BY trip_date</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="st">                    )</span></span>
<span id="cb7-13"><a href="#cb7-13"></a></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="st">                    SELECT *,</span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="st">                    SUM(num_trips) </span></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="st">                    OVER (</span></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="st">                            ORDER BY trip_date</span></span>
<span id="cb7-18"><a href="#cb7-18"></a><span class="st">                            --Calculates the running total of number of trips--</span></span>
<span id="cb7-19"><a href="#cb7-19"></a><span class="st">                            ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</span></span>
<span id="cb7-20"><a href="#cb7-20"></a><span class="st">                         ) AS cumulative_trips</span></span>
<span id="cb7-21"><a href="#cb7-21"></a><span class="st">                    FROM trips_by_day</span></span>
<span id="cb7-22"><a href="#cb7-22"></a><span class="st">                  &quot;&quot;&quot;</span></span>
<span id="cb7-23"><a href="#cb7-23"></a></span>
<span id="cb7-24"><a href="#cb7-24"></a><span class="co"># Run the query, and return a pandas DataFrame</span></span>
<span id="cb7-25"><a href="#cb7-25"></a>number_of_trips_result <span class="op">=</span> client.query(bike_trips_query).result().to_dataframe()</span>
<span id="cb7-26"><a href="#cb7-26"></a>number_of_trips_result.head()</span></code></pre></div>
</div>
<div class="cell markdown">
<p>We now have a table with the number of trips on a given date in 2015 as well as the total number of tips up to that date.</p>
<h2 id="bike-location-on-a-specific-day">Bike Location on a Specific Day</h2>
</div>
<div class="cell code" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T13:54:21.326122Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T13:54:12.40244Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T13:54:12.402481Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T13:54:21.326969Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T13:54:12.402048Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># Query to identify each bikes location on a certain day at various times (4th of July, 2015)</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>bike_trips_query <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="st">                    SELECT </span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="st">                        bike_id,</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="st">                        TIME(start_date) AS trip_time,</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="st">                        -- First station id tells us which station the bike started trips at that day -- </span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="st">                        FIRST_VALUE(start_station_id)</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="st">                            OVER (</span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="st">                                PARTITION BY bike_id</span></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="st">                                ORDER BY start_date</span></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="st">                                ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="st">                             ) AS first_station_id,</span></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="st">                         -- Last station id tells us which station the bike ended trips at that day-- </span></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="st">                         LAST_VALUE(end_station_id)</span></span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="st">                            OVER (</span></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="st">                                PARTITION BY bike_id</span></span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="st">                                ORDER BY start_date</span></span>
<span id="cb8-18"><a href="#cb8-18"></a><span class="st">                                ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</span></span>
<span id="cb8-19"><a href="#cb8-19"></a><span class="st">                            ) AS last_station_id,</span></span>
<span id="cb8-20"><a href="#cb8-20"></a><span class="st">                         start_station_id,</span></span>
<span id="cb8-21"><a href="#cb8-21"></a><span class="st">                         end_station_id</span></span>
<span id="cb8-22"><a href="#cb8-22"></a><span class="st">                    FROM `bigquery-public-data.london_bicycles.cycle_hire`</span></span>
<span id="cb8-23"><a href="#cb8-23"></a><span class="st">                    -- The 21st of June is the summer solstice so which is the longest day of the year --</span></span>
<span id="cb8-24"><a href="#cb8-24"></a><span class="st">                    WHERE DATE(start_date) = &#39;2015-06-21&#39; </span></span>
<span id="cb8-25"><a href="#cb8-25"></a><span class="st">                  &quot;&quot;&quot;</span></span>
<span id="cb8-26"><a href="#cb8-26"></a></span>
<span id="cb8-27"><a href="#cb8-27"></a><span class="co"># Run the query, and return a pandas DataFrame</span></span>
<span id="cb8-28"><a href="#cb8-28"></a>bike_location_result <span class="op">=</span> client.query(bike_trips_query).result().to_dataframe()</span>
<span id="cb8-29"><a href="#cb8-29"></a>bike_location_result.head(<span class="dv">10</span>)</span></code></pre></div>
</div>
<div class="cell markdown">
<p>We not have a table with information on each of the bikes movements throught a certain day,which could help us identify the location of a certain bike in a certain time interval.</p>
<h2 id="bike-stations-total-number-of-trips-and-average-trip-duration">Bike Stations: Total Number of Trips and Average Trip Duration</h2>
</div>
<div class="cell code" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T13:34:39.079079Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T13:34:35.451535Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T13:34:35.451579Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T13:34:39.079793Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T13:34:35.45118Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># Query to count the number of trips by start station</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>join_query <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="st">              -- Creating a sub query block c with start station, number of trips and duration--</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="st">             WITH c AS</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="st">             (</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="st">             SELECT </span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="st">                 start_station_id, </span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="st">                  -- Calculating avergae trip durarion from each station --</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="st">                 COUNT(*) as number_of_trips,</span></span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="st">                 -- Calculating avergae trip durarion from each station --</span></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="st">                 ROUND(AVG(trip_duration_minutes)) AS avg_trip_duration_minutes</span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="st">             FROM (</span></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="st">                 SELECT</span></span>
<span id="cb9-14"><a href="#cb9-14"></a><span class="st">                 start_station_id,</span></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="st">                 -- Calculating the trip duration in minutes -- </span></span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="st">                 DATETIME_DIFF(end_date,start_date,minute) AS trip_duration_minutes,</span></span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="st">                 FROM `bigquery-public-data.london_bicycles.cycle_hire`</span></span>
<span id="cb9-18"><a href="#cb9-18"></a><span class="st">             ) </span></span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="st">             GROUP BY start_station_id</span></span>
<span id="cb9-20"><a href="#cb9-20"></a><span class="st">             )</span></span>
<span id="cb9-21"><a href="#cb9-21"></a><span class="st">             SELECT </span></span>
<span id="cb9-22"><a href="#cb9-22"></a><span class="st">                 s.id as station_id, </span></span>
<span id="cb9-23"><a href="#cb9-23"></a><span class="st">                 s.name,</span></span>
<span id="cb9-24"><a href="#cb9-24"></a><span class="st">                 c.number_of_trips,</span></span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="st">                 c.avg_trip_duration_minutes </span></span>
<span id="cb9-26"><a href="#cb9-26"></a><span class="st">             FROM `bigquery-public-data.london_bicycles.cycle_stations` AS s</span></span>
<span id="cb9-27"><a href="#cb9-27"></a><span class="st">             LEFT JOIN c</span></span>
<span id="cb9-28"><a href="#cb9-28"></a><span class="st">             ON s.id = c.start_station_id</span></span>
<span id="cb9-29"><a href="#cb9-29"></a><span class="st">             ORDER BY c.number_of_trips DESC</span></span>
<span id="cb9-30"><a href="#cb9-30"></a><span class="st">             &quot;&quot;&quot;</span></span>
<span id="cb9-31"><a href="#cb9-31"></a></span>
<span id="cb9-32"><a href="#cb9-32"></a><span class="co"># Run the query, and return a pandas DataFrame</span></span>
<span id="cb9-33"><a href="#cb9-33"></a>station_trip_duration_result <span class="op">=</span> client.query(join_query).result().to_dataframe()</span>
<span id="cb9-34"><a href="#cb9-34"></a>station_trip_duration_result.head()</span></code></pre></div>
</div>
<div class="cell markdown">
<p>We now have a table with statistics on the number of trips and average duration for trips starting at that station</p>
<h1 id="data-analysis">Data Analysis</h1>
<p>Now that we have completed extracting the information we can perform some basic analysis on the data.</p>
</div>
<div class="cell code" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T14:28:59.030415Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T14:28:59.003114Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T14:28:59.003143Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T14:28:59.031369Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T14:28:59.00281Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a>trip_duration_result.groupby(<span class="st">&#39;trip_year&#39;</span>).agg(total_trip_duration <span class="op">=</span> (<span class="st">&#39;trip_duration_minutes&#39;</span>,np.<span class="bu">sum</span>),avg_trip_duration <span class="op">=</span> (<span class="st">&#39;trip_duration_minutes&#39;</span>,np.mean) )</span>
<span id="cb10-2"><a href="#cb10-2"></a></span></code></pre></div>
</div>
<div class="cell markdown">
<p><b>2016</b> was the year with the most ride time and the the longest aver trip duration.</p>
<h2 id="bike-locations-and-number-of-trips">Bike Locations and Number of Trips</h2>
</div>
<div class="cell code" data-_kg_hide-output="true" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T14:20:40.257198Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T14:20:40.248638Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T14:20:40.248666Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T14:20:40.258086Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T14:20:40.248356Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="co">#Identifying the top five stations where trips began</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>bike_location_result[<span class="st">&#39;end_station_id&#39;</span>].value_counts().head(<span class="dv">5</span>)</span></code></pre></div>
</div>
<div class="cell code" data-_kg_hide-output="true" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T14:20:49.495463Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T14:20:49.486358Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T14:20:49.486387Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T14:20:49.496069Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T14:20:49.48604Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a><span class="co">#Identifying the top five stations where trips began</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>bike_location_result[<span class="st">&#39;start_station_id&#39;</span>].value_counts().head(<span class="dv">5</span>)</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T14:14:33.560663Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T14:14:33.131386Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T14:14:33.131455Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T14:14:33.561722Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T14:14:33.130498Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="co"># Analyzing the trip start times to identify how many trips begin at various times throughout the day.</span></span>
<span id="cb13-2"><a href="#cb13-2"></a></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="co"># Isolating the time portion from bks_df[&#39;start_time&#39;]</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>start_time <span class="op">=</span> data<span class="op">=</span>bike_location_result[<span class="st">&#39;trip_time&#39;</span>]</span>
<span id="cb13-5"><a href="#cb13-5"></a></span>
<span id="cb13-6"><a href="#cb13-6"></a>start_time_counts <span class="op">=</span> start_time.value_counts()</span>
<span id="cb13-7"><a href="#cb13-7"></a></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="co">#X-axis ticks will have to be set manually since the plot is difficult to read otherwise</span></span>
<span id="cb13-9"><a href="#cb13-9"></a></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="co">#Creating a series that will be populated using a for loop </span></span>
<span id="cb13-11"><a href="#cb13-11"></a>time_series <span class="op">=</span> []</span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">24</span>):</span>
<span id="cb13-13"><a href="#cb13-13"></a>    <span class="co">#Note {:02d} ensures there are leading zeros (01,02,etc.) which is consistent with time formatting</span></span>
<span id="cb13-14"><a href="#cb13-14"></a>    time_series.append(<span class="st">&quot;</span><span class="sc">{:02d}</span><span class="st">:00:00&quot;</span>.<span class="bu">format</span>(x))</span>
<span id="cb13-15"><a href="#cb13-15"></a></span>
<span id="cb13-16"><a href="#cb13-16"></a>time_series.append(<span class="st">&quot;23:59:00&quot;</span>)</span>
<span id="cb13-17"><a href="#cb13-17"></a></span>
<span id="cb13-18"><a href="#cb13-18"></a>fig_dims <span class="op">=</span> (<span class="dv">20</span>, <span class="dv">4</span>)</span>
<span id="cb13-19"><a href="#cb13-19"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>fig_dims)</span>
<span id="cb13-20"><a href="#cb13-20"></a></span>
<span id="cb13-21"><a href="#cb13-21"></a><span class="co">#The x-ticks are set to the time series just created</span></span>
<span id="cb13-22"><a href="#cb13-22"></a>start_time_counts.plot(xticks<span class="op">=</span>time_series)</span>
<span id="cb13-23"><a href="#cb13-23"></a>plt.title(<span class="st">&quot;Ride Start Times throughout the Day&quot;</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T14:15:34.063194Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T14:15:34.046634Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T14:15:34.046677Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T14:15:34.063825Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T14:15:34.045722Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="co">#Identifying number of bikes that were on a trip between noon and 2 pm </span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="bu">len</span>(bike_location_result[(bike_location_result[<span class="st">&#39;trip_time&#39;</span>] <span class="op">&gt;</span> datetime.strptime(<span class="st">&#39;16:00:00&#39;</span>,<span class="st">&#39;%H:%M:%S&#39;</span>).time()) <span class="op">&amp;</span> (bike_location_result[<span class="st">&#39;trip_time&#39;</span>] <span class="op">&lt;</span> datetime.strptime(<span class="st">&#39;17:00:00&#39;</span>,<span class="st">&#39;%H:%M:%S&#39;</span>).time())])</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a><span class="co">#Identifying the top five bikes that made the most trips</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>bike_location_result[<span class="st">&#39;bike_id&#39;</span>].value_counts().head(<span class="dv">5</span>)</span></code></pre></div>
</div>
<div class="cell markdown">
<ul>
<li>The most trips began and ended at the <b>same five stations.</b></li>
<li>The top five bike with the most trips made <b>15-17 trips</b> that day.</li>
<li>The most trips began between the hours of <b>4 pm and 5 pm</b> (2800 in that hour alone).</li>
</ul>
<h2 id="bike-stations">Bike Stations</h2>
</div>
<div class="cell code" data-_kg_hide-output="true" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T13:36:55.205327Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T13:36:55.187494Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T13:36:55.187542Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T13:36:55.206358Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T13:36:55.186742Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a><span class="co">#Identifying station with the longest averge trip duration.</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>station_trip_duration_result[station_trip_duration_result[<span class="st">&#39;avg_trip_duration_minutes&#39;</span>] <span class="op">==</span> station_trip_duration_result[<span class="st">&#39;avg_trip_duration_minutes&#39;</span>].<span class="bu">max</span>()]</span></code></pre></div>
</div>
<div class="cell code" data-_kg_hide-output="true" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T13:38:15.502165Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T13:38:15.487524Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T13:38:15.487555Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T13:38:15.503196Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T13:38:15.487184Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a><span class="co">#Identifying station with the shortest averge trip duration.</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>station_trip_duration_result[station_trip_duration_result[<span class="st">&#39;avg_trip_duration_minutes&#39;</span>] <span class="op">==</span> station_trip_duration_result[<span class="st">&#39;avg_trip_duration_minutes&#39;</span>].<span class="bu">min</span>()]</span></code></pre></div>
</div>
<div class="cell code" data-_kg_hide-output="true" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T13:46:35.197082Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T13:46:35.183099Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T13:46:35.183128Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T13:46:35.198082Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T13:46:35.182806Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a><span class="co">#Identifying station with the least number of trips</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>station_trip_duration_result[station_trip_duration_result[<span class="st">&#39;number_of_trips&#39;</span>] <span class="op">==</span> station_trip_duration_result[<span class="st">&#39;number_of_trips&#39;</span>].<span class="bu">min</span>()]</span></code></pre></div>
</div>
<div class="cell code" data-_kg_hide-output="true" data-execution="{&quot;shell.execute_reply&quot;:&quot;2021-09-25T13:39:56.764337Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2021-09-25T13:39:56.754688Z&quot;,&quot;iopub.execute_input&quot;:&quot;2021-09-25T13:39:56.754716Z&quot;,&quot;iopub.status.idle&quot;:&quot;2021-09-25T13:39:56.765593Z&quot;,&quot;iopub.status.busy&quot;:&quot;2021-09-25T13:39:56.754433Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a><span class="bu">round</span>(station_trip_duration_result[<span class="st">&#39;number_of_trips&#39;</span>].mean())</span></code></pre></div>
</div>
<div class="cell markdown">
<p>On average,</p>
<ul>
<li>The most trips start from <b>Belgrove Street , King's Cross station.</b></li>
<li>The longest trips start from <b>Black Lion Gate, Kensington Gardens station.</b></li>
<li>The least trips start from <b>Here East South, Queen Elizabeth Olympic Park station.</b></li>
<li>We see that five stations have the shortest trip duration. The number of trips from these stations are also above average so these stations may be in a high traffic area where people are commuting short distances frequently.</li>
</ul>
</div>
</body>
</html>
